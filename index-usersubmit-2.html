<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Iowa Points of Interest</title>
  <!-- load leaflet.css library here -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <!-- mapbox assembly css for slider and temporal legend styles -->
  <link href='https://api.mapbox.com/mapbox-assembly/v0.8.0/assembly.min.css' rel='stylesheet'>
  <!--for icon support-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/all.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/v4-shims.css">
  <!-- for icon markers -->
  <link rel="stylesheet" href="css/leaflet.extra-markers.min.css">
  <!-- add custom css styles here -->
  <style>
    /* style the body of the page here */
    body {
      font-family: sans-serif;
      margin: 0px;
      height: 100%;
      width: 100%;
    }

    /* style header */
    header {
      position: fixed;
      top: 12px;
      left: 35px;
      width: 260px;
      height: 50px;
      background-color: rgba(255, 255, 255, 1.0);
      box-shadow: 0px 0px 0px 2px rgba(0, 0, 0, 0.2);
      border-radius: 3px;
      z-index: 800;
    }

    #container {
      margin: 0px;
      width: 100%;
    }

    #contentwrapper {
      float: left;
      width: 100%;
      overflow: hidden;
    }

    #leftcolumn {
      float: left;
      width: 23%;
      background: #FFFFF0;
      padding: 0px;
      height: 100%;
    }

    #contentcolumn {
      float: left;
      margin: 0px;
      width: 77%;
      margin-bottom: 0px;
    }

    .innertube {
      margin: 5px;
      margin-top: 10px;
    }

    #map {
      position: fixed;
      top: 0px;
      bottom: 0px;
      width: 77%;
      background: white;
      border-left: 1px solid gray;
    }

    /* the text inputs */
    h1 {
      color: black;
      font-size: 18px;
      display: inline-block;
      margin-top: 0.25em;
      margin-bottom: 0.0em;
      margin-left: 0.0em;
      margin-right: 0;
      font-weight: bold;
      text-transform: uppercase;
    }

    h2 {
      color: black;
      font-size: 12px;
      display: inline-block;
      margin-top: 0.0em;
      margin-bottom: 0.0em;
      margin-left: 0.75em;
      margin-right: 0;
    }

    h3 {
      color: black;
      font-size: 12px;
      display: inline-block;
      margin-top: 0.0em;
      margin-bottom: 0.0em;
      margin-left: 0.0em;
      margin-right: 0;
    }

    #button {
      background-color: #4f8ec9;
      /* Off Blue */
      border: none;
      border-radius: 4px;
      color: white;
      padding: 5px 10px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 12px;
      transition-duration: 0.1s;
    }

    #button:hover {
      background-color: #add8e6;
      /* Light Blue */
      color: white;
    }

    .leaflet-grab {
      cursor: pointer;
    }

    hr.someClass {
      width: 100%;
      height: 6px;
      border-top: 1px solid black
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="contentwrapper">
      <div id="leftcolumn">
        <div class="innertube">
          <h1><b>User-Added Points</b></h1><br><br>
          <h3>Use this form to add a point of interest to the map. For latitude and longitude, click on the map to fill in the form. If you know the coordinates, you can also enter these manually. For the year range entry, enter a descriptive range or specific date (ex: 1985, 1920-1929, or May 22, 1990). For start and end years, use the same year for both
            if the point refers to something that happened in one year. Otherwise, use these entries to define a time span. Upon submission, reload the map to see your point. It may take a few minutes before the changes are logged and your point
            appears.</h3><br><br>
          <form name="userInputs">
            <h3>Type:&nbsp&nbsp</h3><select id="type" name="type">
              <option value="Event">Event </option>
              <option value="Person">Person </option>
              <option value="Episcopal Church">Episcopal Church </option>
              <option value="Other Place of Worship">Other Place of Worship </option>
              <option value="Town">Populated Place </option>
              <option value="Railroad">Railroad </option>
              <option value="Other">Other</option>
            </select><br>
            <h3>Latitude:&nbsp&nbsp</h3><input id="lat" name="lat" type="text" placeholder="42.0"><br>
            <h3>Longitude:&nbsp&nbsp</h3><input id="long" name="long" type="text" placeholder="-93.5"><br>
            <h3>Community Name:&nbsp&nbsp</h3><input id="town" name="town" type="text" placeholder="Ames"><br>
            <h3>Point Name:&nbsp&nbsp</h3><input id="event" name="event" type="text" placeholder="John Doe"><br>
            <h3>Description:&nbsp&nbsp</h3><textarea id="moreInfo" name="moreInfo" type="text" rows="3" placeholder="On this spot, John Doe did some noteworthy things."></textarea><br>
            <h3>Year Range:&nbsp&nbsp</h3><input id="year" name="year" type="text" placeholder="1920s"><br>
            <h3>Start Year:&nbsp&nbsp</h3><input id="startYear" name="startYear" type="text" placeholder="1920"><br>
            <h3>End Year:&nbsp&nbsp</h3><input id="endYear" name="endYear" type="text" placeholder="1929"><br><br>
            <div class="centered" style="text-align: center;">
              <button id="button" type="reset">Reset</button>
              <button id="button" type="submit">Send</button>
            </div>
          </form>
        </div>
      </div>
      <div id="contentcolumn">
        <!-- define a div called "map" here -->
        <div id="map"></div>
      </div>
    </div>
  </div>
  <!-- load leaflet.js library here -->
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <!--d3js for requesting files into web application-->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <!-- jquery for easy access to divs -->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <!-- to create csv docs from json -->
  <script src="https://cdn.jsdelivr.net/npm/json2csv"></script>
  <!-- for icon markers -->
  <script src="js/leaflet.extra-markers.min.js"></script>
  <!-- for grouped layer control -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-groupedlayercontrol/0.6.1/leaflet.groupedlayercontrol.min.js"></script>
  <!-- are these necessary? -->
  <script src="https://wzrd.in/standalone/formdata-polyfill"></script>
  <script src="https://wzrd.in/standalone/promise-polyfill@latest"></script>
  <script src="https://wzrd.in/standalone/whatwg-fetch@latest"></script>
  <!-- papaparse for bringing in google spreadsheet data -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js "></script>
  <!-- javascript here -->
  <script>

    // the location of the form input to google sheet script
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyL7KfWDvjkcCkrp4zomgj9yQNg-y94JLzeMYmuRq9v5WEeHOhb/exec';
    // define the html form on this page
    const form = document.forms['userInputs'];

    // upon submitting the form
    form.addEventListener('submit', e => {
      e.preventDefault()
      // post inputs to the google sheet
      fetch(scriptURL, {
          method: 'POST',
          body: new FormData(form)
        })
        .then(response => console.log('Success!', response))
        .catch(error => console.error('Error!', error.message))
    });

    // map options
    const options = {
      center: [42, -93], // center on Iowa
      zoom: 8 // set initial zoom to 8
    };

    // instantiate Leaflet map
    const map = L.map('map', options);

    // upon map click fill the input form with the lat, long of the clicked point
    map.on('click', function(e) {
      document.getElementById("lat").value = e.latlng.lat;
      document.getElementById("long").value = e.latlng.lng;
    });

    // use the Jawg Sunny base map - nice, clean, not fussy
    L.tileLayer('https://{s}.tile.jawg.io/jawg-sunny/{z}/{x}/{y}{r}.png?access-token=odaScIS8yTVoAy0mjYBoHMXXasRTvbpjrTyjwQiZutN3FU3WE82xJ6FyqbbglesB', {
      attribution: '<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      minZoom: 0,
      maxZoom: 22,
      subdomains: 'abcd',
      accessToken: 'odaScIS8yTVoAy0mjYBoHMXXasRTvbpjrTyjwQiZutN3FU3WE82xJ6FyqbbglesB'
    }).addTo(map); // add the base map to the map;

    // add a scale bar
    L.control.scale({
      position: 'bottomright' // position the scale bar at the bottom-left corner
    }).addTo(map);

    // define layer groups
    var episcopalLayer = L.layerGroup();
    var otherPWLayer = L.layerGroup();
    var eventLayer = L.layerGroup();
    var peopleLayer = L.layerGroup();
    var townLayer = L.layerGroup();
    var railLayer = L.layerGroup();
    var otherLayer = L.layerGroup();

    // define the overlays
    const overlays = {
      "Layers": {
        "Events": eventLayer,
        "People": peopleLayer,
        "Populated Places": townLayer,
        "Railroads": railLayer,
        "Other": otherLayer,
      },
      "Places of Worship": {
        "Episcopal Churches": episcopalLayer,
        "Other Places of Worship": otherPWLayer,
      },
    }

    // define a layer control and add the overlays
    const layerControl = L.control.groupedLayers(null, overlays, {
      collapsed: false,
    }).addTo(map);

    // retrieve the google sheet
    $.getJSON(
      'https://sheets.googleapis.com/v4/spreadsheets/1fZ71YgNbW0oxMUtao-csfvb5I8GfUqEh3-gVb7JBuZE/values/UserInputs?key=AIzaSyA8z0818hSekRC1lgw8ReYmLyt1cgFl1ns'
    ).then(function(sheet) {
      // define the sheet value results
      let res = sheet.values;
      // use papaparse to parse the google doc
      Papa.parse(Papa.unparse(res), {
        // make sure it knows the first row is the header
        header: true,
        // upon completion...
        complete: function(results) {
          // define data
          let data = results.data;
          // iterate through each row
          data.forEach(function(each) {
            // if the user input is an event...
            if (each.type == "Event") {
              const userEvents = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-calendar-day',
                  prefix: 'fas',
                  markerColor: 'orange', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });
              // bind a popup to each marker
              userEvents.bindPopup("<b>" + each.town + ", Iowa, " + each.year + ":</b><br> " + each.event + "<hr class='someClass'>" + each.moreInfo, {
                closeButton: true
              });
              // open on mouseover
              userEvents.on('mouseover', function() {
                userEvents.openPopup();
              });
              eventLayer.addLayer(userEvents); // add the layer to the layer group
              eventLayer.addTo(map); // add the layer group to the map
            };
            // if the user input is a person...
            if (each.type == "Person") {
              const userPeople = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-user-circle',
                  prefix: 'fas',
                  markerColor: 'blue', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });
              // bind a popup to each marker
              userPeople.bindPopup("<b>" + each.town + ", Iowa, " + each.year + ":</b><br> " + each.event + "<hr class='someClass'>" + each.moreInfo, {
                closeButton: true
              });
              // open on mouseover
              userPeople.on('mouseover', function() {
                userPeople.openPopup();
              });
              peopleLayer.addLayer(userPeople); // add the layer to the layer group
              peopleLayer.addTo(map); // add the layer group to the map
              //layerControl.addOverlay(userPeople, "People"); // add the layer to the layer control
            };
            // if the user input is a church...
            if (each.type == "Episcopal Church") {
              const userEpiscopal = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-place-of-worship',
                  prefix: 'fas',
                  markerColor: 'red', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });
              // bind a popup to each marker
              userEpiscopal.bindPopup("<b>" + each.town + ", Iowa, " + each.year + ":</b><br> " + each.event + "<hr class='someClass'>" + each.moreInfo, {
                closeButton: true
              });
              // open on mouseover
              userEpiscopal.on('mouseover', function() {
                userEpiscopal.openPopup();
              });
              episcopalLayer.addLayer(userEpiscopal); // add the layer to the layer group
              episcopalLayer.addTo(map); // add the layer group to the map
              //layerControl.addOverlay(userEpiscopal, "Places of Worship"); // add the layer to the layer control
            };
            // if the user input is another place of worship...
            if (each.type == "Other Place of Worship") {
              const userOtherPW = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-place-of-worship',
                  prefix: 'fas',
                  markerColor: 'blue', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });
              // bind a popup to each marker
              userOtherPW.bindPopup("<b>" + each.town + ", Iowa, " + each.year + ":</b><br> " + each.event + "<hr class='someClass'>" + each.moreInfo, {
                closeButton: true
              });
              // open on mouseover
              userOtherPW.on('mouseover', function() {
                userOtherPW.openPopup();
              });
              otherPWLayer.addLayer(userOtherPW); // add the layer to the layer group
              otherPWLayer.addTo(map); // add the layer group to the map
              //layerControl.addOverlay(userEpiscopal, "Places of Worship"); // add the layer to the layer control
            };
            // if the user input is a town...
            if (each.type == "Town") {
              const userTowns = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-landmark',
                  prefix: 'fas',
                  markerColor: 'green', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });
              // bind a popup to each marker
              userTowns.bindPopup("<b>" + each.town + ", Iowa, " + each.year + ":</b><br> " + each.event + "<hr class='someClass'>" + each.moreInfo, {
                closeButton: true
              });
              // open on mouseover
              userTowns.on('mouseover', function() {
                userTowns.openPopup();
              });
              townLayer.addLayer(userTowns); // add the layer to the layer group
              townLayer.addTo(map); // add the layer group to the map
              //layerControl.addOverlay(userTowns, "Populated Places"); // add the layer to the layer control
            };
            // if the user input is a railroad...
            if (each.type == "Railroad") {
              const userRails = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-train',
                  prefix: 'fas',
                  markerColor: 'purple', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });
              // bind a popup to each marker
              userRails.bindPopup("<b>" + each.town + ", Iowa, " + each.year + ":</b><br> " + each.event + "<hr class='someClass'>" + each.moreInfo, {
                closeButton: true
              });
              // open on mouseover
              userRails.on('mouseover', function() {
                userRails.openPopup();
              });
              railLayer.addLayer(userRails); // add the layer to the layer group
              railLayer.addTo(map); // add the layer group to the map
            };
            // if the user input is something else...
            if (each.type == "Other") {
              const userOther = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-question-circle',
                  prefix: 'fas',
                  markerColor: 'purple', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });
              // bind a popup to each marker
              userOther.bindPopup("<b>" + each.town + ", Iowa, " + each.year + ":</b><br> " + each.event + "<hr class='someClass'>" + each.moreInfo, {
                closeButton: true
              });
              // open on mouseover
              userOther.on('mouseover', function() {
                userOther.openPopup();
              });
              otherLayer.addLayer(userOther); // add the layer to the layer group
              otherLayer.addTo(map); // add the layer group to the map
            };
          });
        }
      });
    });
/*
        var churchLayer = L.layerGroup();
        var peopleLayer = L.layerGroup();
        var townLayer = L.layerGroup();

        // define the overlays
        const overlays = {
          "Places of Worship": churchLayer,
          "People": peopleLayer,
          "Populated Places": townLayer,
        };

        // define a layer control and add the overlays
        const layerControl = L.control.layers(null, overlays, {
          collapsed: false,
        }).addTo(map);

        // use papaparse to parse the google doc and cors-anywhere to avoid CORS error
        Papa.parse("https://cors-anywhere.herokuapp.com/https://docs.google.com/spreadsheets/d/1d1BaOwbR9om38Li3L3qvqpWSjZpc5XM4ATT1i1U5qAQ/pub?gid=0&single=true&output=csv", {
          download: true, // download csv
          header: true, // make sure it knows the first row is the header
          // upon completion..
          complete: function(results) {
            // define data
            let data = results.data;
            // iterate through each row
            data.forEach(function(each) {
              // if the user input is a church...
              if (each.type == "Church") {
                const userChurches = L.marker([each.lat, each.long], {
                  icon: L.ExtraMarkers.icon({
                    icon: 'fas fa-place-of-worship',
                    prefix: 'fas',
                    markerColor: 'red', // give the marker a color
                    iconColor: 'white' // give the icon in the marker a color
                  })
                }).addTo(map);
                // bind a popup to each marker
                userChurches.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr>" + each.moreInfo, {
                  closeButton: false
                });
                // open on mouseover
                userChurches.on('mouseover', function() {
                  userChurches.openPopup();
                });
                // close on mouseout
                userChurches.on('mouseout', function() {
                  userChurches.closePopup();
                });
                churchLayer.addLayer(userChurches); // add the layer to the layer group
                //layerControl.addOverlay(userChurches, "Places of Worship"); // add the layer to the layer control
              };
              // if the user input is a person...
              if (each.type == "Person") {
                const userPeople = L.marker([each.lat, each.long], {
                  icon: L.ExtraMarkers.icon({
                    icon: 'fas fa-user-circle',
                    prefix: 'fas',
                    markerColor: 'blue', // give the marker a color
                    iconColor: 'white' // give the icon in the marker a color
                  })
                }).addTo(map);
                // bind a popup to each marker
                userPeople.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr>" + each.moreInfo, {
                  closeButton: false
                });
                // open on mouseover
                userPeople.on('mouseover', function() {
                  userPeople.openPopup();
                });
                // close on mouseout
                userPeople.on('mouseout', function() {
                  userPeople.closePopup();
                });
                peopleLayer.addLayer(userPeople); // add the layer to the layer group
                //layerControl.addOverlay(userPeople, "People"); // add the layer to the layer control
              };
              // if the user input is a town...
              if (each.type == "Town") {
                const userTowns = L.marker([each.lat, each.long], {
                  icon: L.ExtraMarkers.icon({
                    icon: 'fas fa-landmark',
                    prefix: 'fas',
                    markerColor: 'green', // give the marker a color
                    iconColor: 'white' // give the icon in the marker a color
                  })
                }).addTo(map);
                // bind a popup to each marker
                userTowns.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr>" + each.moreInfo, {
                  closeButton: false
                });
                // open on mouseover
                userTowns.on('mouseover', function() {
                  userTowns.openPopup();
                });
                // close on mouseout
                userTowns.on('mouseout', function() {
                  userTowns.closePopup();
                });
                townLayer.addLayer(userTowns); // add the layer to the layer group
                //layerControl.addOverlay(userTowns, "Populated Places"); // add the layer to the layer control
              };
            });
          }
        });
    */
  </script>

</body>

</html>
