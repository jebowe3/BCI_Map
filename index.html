<!DOCTYPE html>
<html>

<head>
  <title>Iowa Points of Interest</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- load leaflet.css library here -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@0.7.2/dist/leaflet.css" />
  <!--for icon support-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/all.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/v4-shims.css">
  <!-- for icon markers -->
  <link rel="stylesheet" href="css/leaflet.extra-markers.min.css">
  <!-- Link to css for the map change button -->
  <link rel="stylesheet" href="css/easy-button.css">
  <!-- for the collapsible sidebar -->
  <link rel="stylesheet" href="css/L.Control.Sidebar.css" />
  <!-- for the marker clusters -->
  <link rel="stylesheet" href="css/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="css/MarkerCluster.css" />
  <!-- add custom css styles here -->
  <style>
    body {
      padding: 0;
      margin: 0;
    }

    html,
    body,
    #map {
      height: 100%;
    }

    .lorem {
      font-style: italic;
      color: #AAA;
    }

    body>#sidebar {
      display: none;
    }

    .leaflet-popup-content-wrapper {
      line-height: 10px;
      border-radius: 2px;
      height: 10 px;
      max-height: 400px;
      max-width: 350px;
      overflow: auto;
    }

    .leaflet-popup {
      position: absolute;
      text-align: center;
    }

    .leaflet-popup-content {
      min-width: 100 px !important;
    }

    .logo-resize {
      width: auto;
      height: 80px;
    }

    .resize {
      width: 300px;
      height: auto;
    }

    .spanTxt {
      bottom: 33%;
      position: relative;
    }

    /* style the temporal legend */
    #temporal {
      background-color: white;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      padding-left: 10px;
      padding-right: 10px;
      height: 25px;
      bottom: 0px;
    }

    /* style the slider control */
    #slider {
      z-index: 1000;
      background-color: white;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      height: 25px;
      width: 175%;
      position: absolute;
      left: 92px;
      bottom: 0px;
    }

    /* style the time selection control */
    #time-select {
      z-index: 1000;
      padding-top: 4px;
      padding-bottom: 0px;
      padding-left: 4px;
      background: rgba(255, 255, 255, 1.0);
      box-shadow: 0px 0px 0px 1px rgba(192, 192, 192, 1.0);
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      height: 25px;
      width: 145px;
      position: absolute;
      bottom: 0px;
      left: 270px;
    }

    #time-select input {
      display: inline-block;
      border: 1px solid #999;
      font-size: 12px;
      border-radius: 4px;
      height: 16px;
      line-height: 16px;
      width: 40px;
    }

    #time-select input[type='submit'] {
      box-sizing: content-box;
      padding-right: 16px;
      text-transform: uppercase;
      color: white;
      background: #5C7DB8;
      border-color: #5C7DB8;
    }

    .slide-bar {
      width: 98%;
    }

    .hide {
      display: none;
    }
  </style>
</head>

<body>
  <div id="sidebar">
    <h1>History of Race in Iowa</h1>

    <a href="https://becomingbelovedcommunity.org/" target="_blank"><img class='logo-resize' src='img/BCI_logo.jpg'/></a>

    <p>A project of the Beloved Community Initiative</p>

    <p><b>Choose from the chapters in the following drop-down menu to learn more about Iowa history.</b></p>

    <select id="chapter-select" class="div-toggle" data-target=".my-info-1">
      <option value="0" selected="selected">[select a chapter]</option>
      <option value="Central" data-show=".central">Central</option>
      <option value="East" data-show=".east">East</option>
      <option value="Metro" data-show=".metro">Metro</option>
      <option value="North Cedar Valley" data-show=".northcedarvalley">North Cedar Valley</option>
      <option value="North Central" data-show=".northcentral">North Central</option>
      <option value="South Central" data-show=".southcentral">South Central</option>
      <option value="Southeast" data-show=".southeast">Southeast</option>
      <option value="Southwest" data-show=".southwest">Southwest</option>
      <option value="Three Rivers" data-show=".threerivers">Three Rivers</option>
      <option value="West" data-show=".west">West</option>
      <option value="General" data-show=".general">Iowa Other</option>
    </select>

    <div id="sidebar-info" class="my-info-1">
      <div id="central-info" class="central hide"><p class="lorem">Central content goes here.</p></div>
      <div id="east-info" class="east hide"><p class="lorem">East content goes here.</p></div>
      <div id="metro-info" class="metro hide"><p class="lorem">Metro content goes here.</p></div>
      <div id="north-cedar-valley-info" class="northcedarvalley hide"><p class="lorem">North Cedar Valley content goes here.</p></div>
      <div id="northcentral-info" class="northcentral hide"><p class="lorem">North Central content goes here.</p></div>
      <div id="southcentral-info" class="southcentral hide"><p class="lorem">South Central content goes here.</p></div>
      <div id="southeast-info" class="southeast hide"><p class="lorem">Southeast content goes here.</p></div>
      <div id="southwest-info" class="southwest hide"><p class="lorem">Southwest content goes here.</p></div>
      <div id="threerivers-info" class="threerivers hide"><p class="lorem">Three Rivers content goes here.</p></div>
      <div id="west-info" class="west hide"><p class="lorem">West content goes here.</p></div>
      <div id="other-info" class="general hide"><p class="lorem">Iowa Other content goes here.</p></div>
    </div>

  </div>

  <div id="map"></div>

  <!-- temporal legend -->
  <div id='temporal' class='leaflet-temporal'>
    <p class="spanTxt"><b>Year: <span class="spanTxt"></span></b></p>
    <!--<h3 class='txt-bold'>Year: <span class="spanTxt"></span></h3>-->
  </div>
  <!-- end temporal -->
  <!-- ui slider -->
  <div id='slider' class='leaflet-slider'>
    <input type='range' min="1400" max="2020" value="1400" step="1" class="slide-bar" />
  </div>
  <!-- end slider -->
  <!-- time select control -->
  <div id="time-select" class="leaflet-bar">
    <form action="#" id="form">
      <label for="year">
        Year
        <input id="year" type="year" name="year">
      </label>
      <input type="submit" value="Update">
    </form>
  </div>
  <!-- end time select control -->

  <!-- load leaflet.js library here -->
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <!--d3js for requesting files into web application-->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <!-- jquery for easy access to divs -->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <!-- for icon markers -->
  <script src="js/leaflet.extra-markers.min.js"></script>
  <!-- for grouped layer control -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-groupedlayercontrol/0.6.1/leaflet.groupedlayercontrol.min.js"></script>
  <!-- papaparse for bringing in google spreadsheet data -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js "></script>
  <!-- for map change button support -->
  <script src='js/easy-button.js'></script>
  <!-- for the collapsible sidebar -->
  <script src="js/L.Control.Sidebar.js"></script>
  <!-- root script for the marker clusters -->
	<script src="js/leaflet.markercluster-src.js"></script>
  <!-- for the layer control marker clusters -->
  <script src="js/leaflet.markercluster.layersupport.js"></script>
  <!-- javascript here -->
  <script>
    // map options
    const options = {
      center: [42, -93], // center on Iowa
      zoom: 8 // set initial zoom to 8
    };

    // instantiate Leaflet map
    const map = L.map('map', options);

    // Set the currentYear to whatever value is in the slider on load
    let currentYear = $('.slide-bar').val();

    // define the year input form
    const timeForm = document.getElementById('form');

    const timeSelect = L.control({
      position: 'bottomleft' // place the temporal legend at bottom left corner
    });

    // when added to the map
    timeSelect.onAdd = function(map) {

      let timeFormDiv = L.DomUtil.get("time-select"); // get the style settings

      // disable the mouse events
      L.DomEvent.addListener(timeFormDiv, 'mousedown', function(e) {
        L.DomEvent.stopPropagation(e);
      });

      return timeFormDiv; // return the style settings

    }

    timeSelect.addTo(map); // add the temporal legend to the map

    // use the Jawg Sunny base map - nice, clean, not fussy
    L.tileLayer('https://{s}.tile.jawg.io/jawg-sunny/{z}/{x}/{y}{r}.png?access-token=odaScIS8yTVoAy0mjYBoHMXXasRTvbpjrTyjwQiZutN3FU3WE82xJ6FyqbbglesB', {
      attribution: '<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      minZoom: 0,
      maxZoom: 22,
      subdomains: 'abcd',
      accessToken: 'odaScIS8yTVoAy0mjYBoHMXXasRTvbpjrTyjwQiZutN3FU3WE82xJ6FyqbbglesB'
    }).addTo(map); // add the base map to the map;

    // add a scale bar
    L.control.scale({
      position: 'bottomright' // position the scale bar at the bottom-left corner
    }).addTo(map);

    const sidebar = L.control.sidebar('sidebar', {
      closeButton: true,
      position: 'left'
    });
    map.addControl(sidebar);

    setTimeout(function() {
      sidebar.show();
    }, 500);

    // create a button to allow users to expand or collapse the sidebar
    const toggleSidebarButton = L.easyButton({
      id: 'toggleSidebarButton',
      position: 'topleft',
      states: [{
        stateName: 'toggle-sidebar',
        icon: 'fas fa-bookmark',
        title: 'Toggle Sidebar',
        onClick: function(e) {
          sidebar.toggle();
        }
      }]
    }).addTo(map);

    $(document).on('change', '.div-toggle', function() {
      var target = $(this).data('target');
      var show = $("option:selected", this).data('show');
      $(target).children().addClass('hide');
      $(show).removeClass('hide');
    });
    $(document).ready(function(){
        $('.div-toggle').trigger('change');
    });

    function getColor(d) {
      return d === "Episcopal Church" ? 'red' :
        d === "Other Place of Worship" ? 'blue' :
        d === "Event" ? 'orange' :
        d === "Person" ? 'blue' :
        d === "Town" ? 'green' :
        d === "Railroad" ? 'purple' :
        d === "Other" ? 'purple' :
        'blue';
    };

    function getIcon(d) {
      return d === "Episcopal Church" ? 'fas fa-place-of-worship' :
        d === "Other Place of Worship" ? 'fas fa-place-of-worship' :
        d === "Event" ? 'fas fa-calendar-day' :
        d === "Person" ? 'fas fa-user-circle' :
        d === "Town" ? 'fas fa-landmark' :
        d === "Railroad" ? 'fas fa-train' :
        d === "Other" ? 'fas fa-question-circle' :
        'fas fa-question-circle';
    };

    // define the clustered layer support
    var mcgLayerSupportGroup = L.markerClusterGroup.layerSupport(),
      // define layer groups
      episcopalLayer = L.layerGroup(),
      otherPWLayer = L.layerGroup(),
      eventLayer = L.layerGroup(),
      peopleLayer = L.layerGroup(),
      townLayer = L.layerGroup(),
      railLayer = L.layerGroup(),
      otherLayer = L.layerGroup(),
      allPoints = L.layerGroup(),
      // define the overlays
      overlays = {
        "Layers": {
          "Events": eventLayer,
          "People": peopleLayer,
          "Populated Places": townLayer,
          "Railroads": railLayer,
          "Other": otherLayer,
        },
        "Places of Worship": {
          "Episcopal Churches": episcopalLayer,
          "Other Places of Worship": otherPWLayer,
        },
        "Everything": {
          "All Historical Points": allPoints,
        },
      },
      // define the layer control and add the overlays
      control = L.control.groupedLayers(null, overlays, {
        collapsed: false,
      }),
      i, a, title, marker;

/*
    // define layer groups
    var episcopalLayer = L.layerGroup();
    var otherPWLayer = L.layerGroup();
    var eventLayer = L.layerGroup();
    var peopleLayer = L.layerGroup();
    var townLayer = L.layerGroup();
    var railLayer = L.layerGroup();
    var otherLayer = L.layerGroup();
    var allPoints = L.layerGroup();

    // define the overlays
    const overlays = {
      "Layers": {
        "Events": eventLayer,
        "People": peopleLayer,
        "Populated Places": townLayer,
        "Railroads": railLayer,
        "Other": otherLayer,
      },
      "Places of Worship": {
        "Episcopal Churches": episcopalLayer,
        "Other Places of Worship": otherPWLayer,
      },
      "Everything": {
        "All Points": allPoints,
      },
    };

    // define a layer control and add the overlays
    const layerControl = L.control.groupedLayers(null, overlays, {
      collapsed: false,
    }).addTo(map);
*/
    // add the clustered layer support to the map
    mcgLayerSupportGroup.addTo(map);
    // check in the layer groups
    mcgLayerSupportGroup.checkIn([episcopalLayer, otherPWLayer, eventLayer, peopleLayer, townLayer, railLayer, otherLayer, allPoints]);

    // add the cluster layer control to the map
    control.addTo(map);

    // create a button to take users to the user input map
    const userInputButton = L.easyButton({
      id: 'userInputButton',
      position: 'topright',
      states: [{
        stateName: 'change-map',
        icon: 'fas fa-map-pin',
        title: 'Add a Point!',
        onClick: function(e) {
          window.location.href = 'index-usersubmit-3.html';
        }
      }]
    }).addTo(map);

    // define the temporal legend element for visibility toggling
    const temporalElement = document.getElementById('temporal');
    // define the time slider element for visibility toggling
    const sliderElement = document.getElementById('slider');
    // define the time select element for visibility toggling
    const timeSelectElement = document.getElementById('time-select');

    // define an empty array to hold sidebar content
    const chapterContent = [];

    // if 'All Points' is checked in the layer control...
    // remove the other layers and the time controls and legend
    map.on('overlayadd', function(eo) {
      if (eo.name === 'All Historical Points') {
        setTimeout(function() {
          map.removeLayer(eventLayer),
          map.removeLayer(peopleLayer),
          map.removeLayer(townLayer),
          map.removeLayer(railLayer),
          map.removeLayer(otherLayer),
          map.removeLayer(episcopalLayer),
          map.removeLayer(otherPWLayer),
          sliderElement.style.display = "none",
          temporalElement.style.display = "none",
          timeSelectElement.style.display = "none"
        }, 10);
      // otherwise add them back
      } else {
        setTimeout(function() {
          map.removeLayer(allPoints),
          sliderElement.style.display = "block",
          temporalElement.style.display = "block",
          timeSelectElement.style.display = "block"
        }, 10);
      }
    });

    // retrieve the google sheet
    $.getJSON(
      'https://sheets.googleapis.com/v4/spreadsheets/1fZ71YgNbW0oxMUtao-csfvb5I8GfUqEh3-gVb7JBuZE/values/MainMap?key=AIzaSyA8z0818hSekRC1lgw8ReYmLyt1cgFl1ns'
    ).then(function(sheet) {
      // define the sheet value results
      let res = sheet.values;
      // use papaparse to parse the google doc
      Papa.parse(Papa.unparse(res), {
        // make sure it knows the first row is the header
        header: true,
        // upon completion...
        complete: function(results) {

          // define data
          let data = results.data;

          // sort the data by startYear
          data.sort(function(a,b){
            // return earliest years first
            return new Date(a.startYear) - new Date(b.startYear);
          });

          // define the initial chapter in the dropdown menu
          const chapterInitial = document.getElementById("chapter-select").value;
          // define the sidebar information
          const centralInfo = document.getElementById("central-info");
          const eastInfo = document.getElementById("east-info");
          const metroInfo = document.getElementById("metro-info");
          const northCVInfo = document.getElementById("north-cedar-valley-info");
          const northCentralInfo = document.getElementById("northcentral-info");
          const southCentralInfo = document.getElementById("southcentral-info");
          const southeastInfo = document.getElementById("southeast-info");
          const southwestInfo = document.getElementById("southwest-info");
          const threeriversInfo = document.getElementById("threerivers-info");
          const westInfo = document.getElementById("west-info");
          const otherInfo = document.getElementById("other-info");

          // when the chapter selection is changed
          document.getElementById("chapter-select").onchange = function() {
            // empty the chapterContent array
            chapterContent.length = 0;
            // define the selected chapter
            const chapterSelected = document.getElementById("chapter-select").value;
            // for each sorted point...
            data.forEach(function(each) {
              // if "Central" is selected...
              if (chapterSelected == "Central") {
                // add the Central chapter content to the chapterContent array
                if (each.Chapter == "Central") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                centralInfo.innerHTML = chapterContent.join("");
              };
              // if "East" is selected...
              if (chapterSelected == "East") {
                // add the East chapter content to the chapterContent array
                if (each.Chapter == "East") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                eastInfo.innerHTML = chapterContent.join("");
              };
              // if "Metro" is selected...
              if (chapterSelected == "Metro") {
                // add the Metro chapter content to the chapterContent array
                if (each.Chapter == "Metro") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                metroInfo.innerHTML = chapterContent.join("");
              };
              // if "North Cedar Valley" is selected...
              if (chapterSelected == "North Cedar Valley") {
                // add the North Cedar Valley chapter content to the chapterContent array
                if (each.Chapter == "North Cedar Valley") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                northCVInfo.innerHTML = chapterContent.join("");
              };
              // if "North Central" is selected...
              if (chapterSelected == "North Central") {
                // add the North Central chapter content to the chapterContent array
                if (each.Chapter == "North Central") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                northCentralInfo.innerHTML = chapterContent.join("");
              };
              // if "South Central" is selected...
              if (chapterSelected == "South Central") {
                // add the South Central chapter content to the chapterContent array
                if (each.Chapter == "South Central") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                southCentralInfo.innerHTML = chapterContent.join("");
              };
              // if "Southeast" is selected...
              if (chapterSelected == "Southeast") {
                // add the Southeast chapter content to the chapterContent array
                if (each.Chapter == "Southeast") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                southeastInfo.innerHTML = chapterContent.join("");
              };
              // if "Southwest" is selected...
              if (chapterSelected == "Southwest") {
                // add the Southwest chapter content to the chapterContent array
                if (each.Chapter == "Southwest") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                southwestInfo.innerHTML = chapterContent.join("");
              };

              // if "Three Rivers" is selected...
              if (chapterSelected == "Three Rivers") {
                // add the Three Rivers chapter content to the chapterContent array
                if (each.Chapter == "Three Rivers") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                threeriversInfo.innerHTML = chapterContent.join("");
              };
              // if "West" is selected...
              if (chapterSelected == "West") {
                // add the West chapter content to the chapterContent array
                if (each.Chapter == "West") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                westInfo.innerHTML = chapterContent.join("");
              };
              // if "Other" is selected...
              if (chapterSelected == "General") {
                // add the Other chapter content to the chapterContent array
                if (each.Chapter == "-") {
                  chapterContent.push("<div class='story' data-point='" + each.lat + "," + each.long + "'><br><b>" + each.event + ", " + each.town + ", " + each.startYear + "</b><br>" + each.moreInfo + "</div>");
                };
                // redefine the div
                otherInfo.innerHTML = chapterContent.join("");
              };
            });
          };

          // iterate through each row
          data.forEach(function(each) {

            // declare empty markers to be updated with later conditions
            let episcopalChurches = L.marker([each.lat, each.long], {
              icon: L.ExtraMarkers.icon({
                icon: 'fas fa-user-circle',
                prefix: 'fas',
                markerColor: 'blue', // give the marker a color
                iconColor: 'rgba(0,0,0,0)', // give the icon in the marker a color
                iconSize: [0, 0],
                shadowSize: [0, 0]
              })
            });
            let otherPW = L.marker([each.lat, each.long], {
              icon: L.ExtraMarkers.icon({
                icon: 'fas fa-user-circle',
                prefix: 'fas',
                markerColor: 'blue', // give the marker a color
                iconColor: 'rgba(0,0,0,0)', // give the icon in the marker a color
                iconSize: [0, 0],
                shadowSize: [0, 0]
              })
            });
            let eventPoints = L.marker([each.lat, each.long], {
              icon: L.ExtraMarkers.icon({
                icon: 'fas fa-user-circle',
                prefix: 'fas',
                markerColor: 'blue', // give the marker a color
                iconColor: 'rgba(0,0,0,0)', // give the icon in the marker a color
                iconSize: [0, 0],
                shadowSize: [0, 0]
              })
            });
            let peoplePoints = L.marker([each.lat, each.long], {
              icon: L.ExtraMarkers.icon({
                icon: 'fas fa-user-circle',
                prefix: 'fas',
                markerColor: 'blue', // give the marker a color
                iconColor: 'rgba(0,0,0,0)', // give the icon in the marker a color
                iconSize: [0, 0],
                shadowSize: [0, 0]
              })
            });
            let townPoints = L.marker([each.lat, each.long], {
              icon: L.ExtraMarkers.icon({
                icon: 'fas fa-user-circle',
                prefix: 'fas',
                markerColor: 'blue', // give the marker a color
                iconColor: 'rgba(0,0,0,0)', // give the icon in the marker a color
                iconSize: [0, 0],
                shadowSize: [0, 0]
              })
            });
            let railPoints = L.marker([each.lat, each.long], {
              icon: L.ExtraMarkers.icon({
                icon: 'fas fa-user-circle',
                prefix: 'fas',
                markerColor: 'blue', // give the marker a color
                iconColor: 'rgba(0,0,0,0)', // give the icon in the marker a color
                iconSize: [0, 0],
                shadowSize: [0, 0]
              })
            });
            let other = L.marker([each.lat, each.long], {
              icon: L.ExtraMarkers.icon({
                icon: 'fas fa-user-circle',
                prefix: 'fas',
                markerColor: 'blue', // give the marker a color
                iconColor: 'rgba(0,0,0,0)', // give the icon in the marker a color
                iconSize: [0, 0],
                shadowSize: [0, 0]
              })
            });

            // *** All of the Points ***
            let everyPoint = L.marker([each.lat, each.long], {
              icon: L.ExtraMarkers.icon({
                icon: getIcon(each.type),
                prefix: 'fas',
                markerColor: getColor(each.type), // give the marker a color
                iconColor: 'white' // give the icon in the marker a color
              })
            });

            // declare an empty string variable
            var popImage = "";

            // if the imageLink is present...
            if (each.imageLink != undefined) {
              // define popImage as...
              var popImage = "<br><img class='resize' src='" + each.imageLink + "'" + "/>";
              // otherwise...
            } else {
              // make sure it remains an empty string
              var popImage = "";
            };

            everyPoint.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr class='lineClass'>" + each.moreInfo + popImage, {
              closeButton: true,
            });
            // open on mouseover
            everyPoint.on('mouseover', function() {
              everyPoint.openPopup();
            });
            // add the layer to the layer group
            allPoints.addLayer(everyPoint);
            // add the layer group to the map
            allPoints.addTo(map);
            // *** All of the Points ***

            // if the marker is an episcopal church...
            if (each.type == "Episcopal Church") {
              episcopalChurches = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-place-of-worship',
                  prefix: 'fas',
                  markerColor: 'red', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });

              // declare an empty string variable
              var popImage = "";

              // if the imageLink is present...
              if (each.imageLink != undefined) {
                // define popImage as...
                var popImage = "<br><img class='resize' src='" + each.imageLink + "'" + "/>";
                // otherwise...
              } else {
                // make sure it remains an empty string
                var popImage = "";
              };

              // bind a popup to each marker
              episcopalChurches.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr class='lineClass'>" + each.moreInfo + popImage, {
                closeButton: true,
                //maxWidth: 300,
                //maxHeight: 400,
              });
              // open on mouseover
              episcopalChurches.on('mouseover', function() {
                episcopalChurches.openPopup();
              });
              /*
                            // close on mouseout
                            episcopalChurches.on('mouseout', function() {
                              episcopalChurches.closePopup();
                            });
              */
              // if the currentYear is greater than or equal to the startYear and less than or equal to the endYear
              if (currentYear >= each.startYear && currentYear <= each.endYear) {
                episcopalLayer.addLayer(episcopalChurches); // add the layer to the layer group;
              } else {
                episcopalLayer.removeLayer(episcopalChurches); // remove the layer from the layer group;
              };
              // add the layer group to the map
              //episcopalLayer.addTo(map);
            };
            // if the marker is another place of worship...
            if (each.type == "Other Place of Worship") {
              otherPW = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-place-of-worship',
                  prefix: 'fas',
                  markerColor: 'blue', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });

              // declare an empty string variable
              var popImage = "";

              // if the imageLink is present...
              if (each.imageLink != undefined) {
                // define popImage as...
                var popImage = "<br><img class='resize' src='" + each.imageLink + "'" + "/>";
                // otherwise...
              } else {
                // make sure it remains an empty string
                var popImage = "";
              };

              // bind a popup to each marker
              otherPW.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr class='lineClass'>" + each.moreInfo + popImage, {
                closeButton: true,
                //maxWidth: 300,
                //maxHeight: 400,
              });
              // open on mouseover
              otherPW.on('mouseover', function() {
                otherPW.openPopup();
              });
              /*
                            // close on mouseout
                            episcopalChurches.on('mouseout', function() {
                              episcopalChurches.closePopup();
                            });
              */
              // if the currentYear is greater than or equal to the startYear and less than or equal to the endYear
              if (currentYear >= each.startYear && currentYear <= each.endYear) {
                otherPWLayer.addLayer(otherPW); // add the layer to the layer group;
              } else {
                otherPWLayer.removeLayer(otherPW); // remove the layer from the layer group;
              };
              // add the layer group to the map
              //otherPWLayer.addTo(map);
            };
            // if the marker is an event...
            if (each.type == "Event") {
              eventPoints = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-calendar-day',
                  prefix: 'fas',
                  markerColor: 'orange', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });

              // declare an empty string variable
              var popImage = "";

              // if the imageLink is present...
              if (each.imageLink != undefined) {
                // define popImage as...
                var popImage = "<br><img class='resize' src='" + each.imageLink + "'" + "/>";
                // otherwise...
              } else {
                // make sure it remains an empty string
                var popImage = "";
              };

              // bind a popup to each marker
              eventPoints.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr class='lineClass'>" + each.moreInfo + popImage, {
                closeButton: true,
                //maxWidth: 300,
                //maxHeight: 400,
              });
              // open on mouseover
              eventPoints.on('mouseover', function() {
                eventPoints.openPopup();
              });
              /*
                            // close on mouseout
                            eventPoints.on('mouseout', function() {
                              eventPoints.closePopup();
                            });
              */
              // if the currentYear is greater than or equal to the startYear and less than or equal to the endYear
              if (currentYear >= each.startYear && currentYear <= each.endYear) {
                eventLayer.addLayer(eventPoints); // add the layer to the layer group;
              } else {
                eventLayer.removeLayer(eventPoints); // remove the layer from the layer group;
              };
              // add the layer group to the map
              //eventLayer.addTo(map);
            };
            // if the marker is a person...
            if (each.type == "Person") {
              peoplePoints = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-user-circle',
                  prefix: 'fas',
                  markerColor: 'blue', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });

              // declare an empty string variable
              var popImage = "";

              // if the imageLink is present...
              if (each.imageLink != undefined) {
                // define popImage as...
                var popImage = "<br><img class='resize' src='" + each.imageLink + "'" + "/>";
                // otherwise...
              } else {
                // make sure it remains an empty string
                var popImage = "";
              };

              // bind a popup to each marker
              peoplePoints.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr class='lineClass'>" + each.moreInfo + popImage, {
                closeButton: true,
                //maxWidth: 300,
                //maxHeight: 400,
              });
              // open on mouseover
              peoplePoints.on('mouseover', function() {
                peoplePoints.openPopup();
              });
              /*
                            // close on mouseout
                            peoplePoints.on('mouseout', function() {
                              peoplePoints.closePopup();
                            });
              */
              // if the currentYear is greater than or equal to the startYear and less than or equal to the endYear
              if (currentYear >= each.startYear && currentYear <= each.endYear) {
                peopleLayer.addLayer(peoplePoints); // add the layer to the layer group;
              } else {
                peopleLayer.removeLayer(peoplePoints); // remove the layer from the layer group;
              };
              // add the layer group to the map
              //peopleLayer.addTo(map);
            };
            // if the marker is a town...
            if (each.type == "Town") {
              townPoints = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-landmark',
                  prefix: 'fas',
                  markerColor: 'green', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });

              // declare an empty string variable
              var popImage = "";

              // if the imageLink is present...
              if (each.imageLink != undefined) {
                // define popImage as...
                var popImage = "<br><img class='resize' src='" + each.imageLink + "'" + "/>";
                // otherwise...
              } else {
                // make sure it remains an empty string
                var popImage = "";
              };

              // bind a popup to each marker
              townPoints.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr class='lineClass'>" + each.moreInfo + popImage, {
                closeButton: true,
                //maxWidth: 300,
                //maxHeight: 400,
              });
              // open on mouseover
              townPoints.on('mouseover', function() {
                townPoints.openPopup();
              });
              /*
                            // close on mouseout
                            townPoints.on('mouseout', function() {
                              townPoints.closePopup();
                            });
              */
              // if the currentYear is greater than or equal to the startYear and less than or equal to the endYear
              if (currentYear >= each.startYear && currentYear <= each.endYear) {
                townLayer.addLayer(townPoints); // add the layer to the layer group;
              } else {
                townLayer.removeLayer(townPoints); // remove the layer from the layer group;
              };
              // add the layer group to the map
              //townLayer.addTo(map);
            };
            // if the marker is a railroad...
            if (each.type == "Railroad") {
              railPoints = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-train',
                  prefix: 'fas',
                  markerColor: 'purple', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });

              // declare an empty string variable
              var popImage = "";

              // if the imageLink is present...
              if (each.imageLink != undefined) {
                // define popImage as...
                var popImage = "<br><img class='resize' src='" + each.imageLink + "'" + "/>";
                // otherwise...
              } else {
                // make sure it remains an empty string
                var popImage = "";
              };

              // bind a popup to each marker
              railPoints.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr class='lineClass'>" + each.moreInfo + popImage, {
                closeButton: true,
                //maxWidth: 300,
                //maxHeight: 400,
              });
              // open on mouseover
              railPoints.on('mouseover', function() {
                railPoints.openPopup();
              });
              /*
                            // close on mouseout
                            railPoints.on('mouseout', function() {
                              railPoints.closePopup();
                            });
              */
              // if the currentYear is greater than or equal to the startYear and less than or equal to the endYear
              if (currentYear >= each.startYear && currentYear <= each.endYear) {
                railLayer.addLayer(railPoints); // add the layer to the layer group;
              } else {
                railLayer.removeLayer(railPoints); // remove the layer from the layer group;
              };
              // add the layer group to the map
              //railLayer.addTo(map);
            };
            // if the marker is something...
            if (each.type == "Other") {
              other = L.marker([each.lat, each.long], {
                icon: L.ExtraMarkers.icon({
                  icon: 'fas fa-question-circle',
                  prefix: 'fas',
                  markerColor: 'purple', // give the marker a color
                  iconColor: 'white' // give the icon in the marker a color
                })
              });

              // declare an empty string variable
              var popImage = "";

              // if the imageLink is present...
              if (each.imageLink != undefined) {
                // define popImage as...
                var popImage = "<br><img class='resize' src='" + each.imageLink + "'" + "/>";
                // otherwise...
              } else {
                // make sure it remains an empty string
                var popImage = "";
              };

              // bind a popup to each marker
              other.bindPopup("<b>" + each.town + ", Iowa, " + each.startYear + ":</b><br> " + each.event + "<hr class='lineClass'>" + each.moreInfo + popImage, {
                closeButton: true,
                //maxWidth: 300,
                //maxHeight: 400,
              });
              // open on mouseover
              other.on('mouseover', function() {
                other.openPopup();
              });
              /*
                            // close on mouseout
                            episcopalChurches.on('mouseout', function() {
                              episcopalChurches.closePopup();
                            });
              */
              // if the currentYear is greater than or equal to the startYear and less than or equal to the endYear
              if (currentYear >= each.startYear && currentYear <= each.endYear) {
                otherLayer.addLayer(other); // add the layer to the layer group;
              } else {
                otherLayer.removeLayer(other); // remove the layer from the layer group;
              };
              // add the layer group to the map
              //otherLayer.addTo(map);
            };
            createTemporalLegend(currentYear);
            sequenceUI(each, episcopalChurches, otherPW, eventPoints, peoplePoints, townPoints, railPoints, other, timeForm); // feeds layers to the time slider
            updateLayers(each, episcopalChurches, otherPW, eventPoints, peoplePoints, townPoints, railPoints, other, currentYear); // updates the layers
          }); // end data.forEach
        }
      });
    });

    // add a temporal legend in sync with the UI slider
    function createTemporalLegend(currentYear) {

      const temporalLegend = L.control({
        position: 'bottomleft' // place the temporal legend at bottom left corner
      });

      // when added to the map
      temporalLegend.onAdd = function(map) {

        let div = L.DomUtil.get("temporal"); // get the style settings

        // disable the mouse events
        L.DomEvent.addListener(div, 'mousedown', function(e) {
          L.DomEvent.stopPropagation(e);
        });

        return div; // return the style settings

      }

      $('#temporal span').html(currentYear); // change grade value to that currently selected by UI slider

      temporalLegend.addTo(map); // add the temporal legend to the map

    }; // end createTemporalLegend function

    // add a UI slider
    function sequenceUI(each, episcopalChurches, otherPW, eventPoints, peoplePoints, townPoints, railPoints, other, timeForm) {

      // create Leaflet control for the slider
      const sliderControl = L.control({
        position: 'bottomleft',
        follow: true
      });

      // add controls to the slider
      sliderControl.onAdd = function(map) {

        let controls = L.DomUtil.get("slider"); // get the style settings

        // disable map dragging while mouse is pressed over slider
        L.DomEvent.addListener(controls, 'mousedown', function(e) {
          map.dragging.disable();
        });

        // enable map dragging when mouse leaves slider
        L.DomEvent.addListener(controls, 'mouseout', function(e) {
          map.dragging.enable();
        });

        return controls; // return the style settings

      }

      // add the control to the map
      sliderControl.addTo(map);

      // if a year is submitted on timeForm...
      timeForm.addEventListener('submit', function updateTimeRange(e) {
        var currentYear = document.getElementById('year').value; // define currentYear as the submitted year
        $('.slide-bar').val(currentYear); // adjust the time slider to the submitted year
        createTemporalLegend(currentYear); // run this function
        updateLayers(each, episcopalChurches, otherPW, eventPoints, peoplePoints, townPoints, railPoints, other, currentYear); // updates the layers
        e.preventDefault(); // prevent defaulting
      });

      $('.slide-bar')
        .on('input change', function() {
          let currentYear = $(this).val(); // identifies the year selected
          createTemporalLegend(currentYear);
          updateLayers(each, episcopalChurches, otherPW, eventPoints, peoplePoints, townPoints, railPoints, other, currentYear); // updates the layers
        });

    }; // end sequenceUI function

    // update the layers based on the time slider year
    function updateLayers(each, episcopalChurches, otherPW, eventPoints, peoplePoints, townPoints, railPoints, other, currentYear) {

      // if the currentYear is greater than or equal to the startYear and less than or equal to the endYear
      if (currentYear >= each.startYear && currentYear <= each.endYear) {
        episcopalLayer.addLayer(episcopalChurches); // add the layer to the layer group;
        otherPWLayer.addLayer(otherPW);
        eventLayer.addLayer(eventPoints);
        peopleLayer.addLayer(peoplePoints);
        townLayer.addLayer(townPoints);
        railLayer.addLayer(railPoints);
        otherLayer.addLayer(other);
      } else {
        episcopalLayer.removeLayer(episcopalChurches); // remove the layer from the layer group;
        otherPWLayer.removeLayer(otherPW);
        eventLayer.removeLayer(eventPoints);
        peopleLayer.removeLayer(peoplePoints);
        townLayer.removeLayer(townPoints);
        railLayer.removeLayer(railPoints);
        otherLayer.removeLayer(other);
      };

    }; // end updateLayers function
  </script>
</body>

</html>
